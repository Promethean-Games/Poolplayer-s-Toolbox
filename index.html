<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Promethean Break Speed v0.2.1 — Promethean Games</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --pg-bg:#0c0c0c; --pg-panel:#151515; --pg-accent:#d11111; --pg-text:#f5f5f5; --pg-subtext:#c7c7c7;
      --cloth:#03C04A;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    body { background: var(--pg-bg); color: var(--pg-text); }
    .pg-panel { background: var(--pg-panel); border-radius:0.75rem; }
    .tap-big { font-size: 1.1rem; padding: 0.9rem 1.1rem; border-radius: 0.75rem; }
    .nav-fixed { position: fixed; bottom: 0; left: 0; right: 0; border-top: 1px solid #262626; background:#0c0c0c; padding-bottom: max(0.5rem, var(--safe-bottom)); }
    .btn { background:#1f1f1f; color:#e5e5e5; padding: .6rem .9rem; border-radius:.65rem; }
    .btn:active { transform: translateY(1px); }
    .seg { display:inline-flex; background:#1b1b1b; border-radius:9999px; padding:4px; gap:4px; }
    .seg button { padding:8px 12px; border-radius:9999px; font-size:13px; color:#e5e5e5; }
    .seg .on { background:#2b2b2b; box-shadow:0 0 0 2px #3a3a3a inset; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.72); display:flex; align-items:center; justify-content:center; padding: 12px; z-index: 50; }
    .icon-btn { display:flex; align-items:center; justify-content:center; font-size:20px; }
    .round-record { width: 96px; height: 96px; border-radius: 9999px; background: #d11111; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .round-record:active { transform: translateY(1px) scale(0.98); }
    .vslider-wrap{ display:flex; align-items:center; justify-content:center; min-height: 220px; }
    .vslider { appearance:none; width: 360px; height: 14px; transform: rotate(-90deg) scaleX(-1); background:#1b1b1b; border-radius:9999px; outline:none; }
    .vslider::-webkit-slider-thumb { appearance:none; width:24px; height:24px; background:#d11111; border-radius:50%; border:2px solid #3a3a3a; }
    .vslider::-moz-range-thumb { width:24px; height:24px; background:#d11111; border-radius:50%; border:2px solid #3a3a3a; }
    .tile { border-radius: 0.75rem; overflow: hidden; border:1px solid #2a2a2a; transition: box-shadow .15s ease, background .15s ease; }
    .tile.selected { background:#5a0e0e; box-shadow:0 0 0 2px #d11111 inset; }
    .chk { -webkit-appearance:none; appearance:none; width:26px; height:26px; border-radius:8px; border:2px solid #3a3a3a; background:#1b1b1b; display:inline-block; position:relative; }
    .chk:checked { background:#d11111; border-color:#8c0b0b; }
    .chk:checked::after { content:"✓"; position:absolute; top:50%; left:50%; transform:translate(-50%,-54%); font-size:16px; color:#fff; font-weight:800; }
    .table-svg { background:#151515; border-radius:0.75rem; }
    .noselect { user-select:none; -webkit-user-select:none; -webkit-tap-highlight-color: transparent; }
    .dot { width:8px; height:8px; border-radius:9999px; background:#444; }
    .dot.on { background:#d11111; }
    .help-icon { width:22px; height:22px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; background:#1f1f1f; border:1px solid #2d2d2d; color:#ddd; font-weight:700; cursor:pointer; }
    .help-icon:hover { background:#2a2a2a; }
    /* Mobile optimizations */
    .modal-card { width: min(94vw, 720px); max-height: min(86vh, 720px); display:flex; flex-direction:column; }
    .modal-body { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .touch-area { min-height: 220px; }
    /* Preset buttons */
    .preset-btn { font-size:12px; padding:.5rem .6rem; border-radius:.6rem; background:#1b1b1b; border:1px solid #2a2a2a; }
    .preset-btn.saved { background:#241414; border-color:#3a1e1e; }
  </style>
</head>
<body class="noselect">
  <div id="root" class="pb-24"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useRef, useState } = React;

    class ErrorBoundary extends React.Component {
      constructor(p){ super(p); this.state={hasError:false, err:null}; }
      static getDerivedStateFromError(e){ return {hasError:true, err:e}; }
      componentDidCatch(e, info){ console.error(e, info); }
      render(){ if(this.state.hasError){ return <div className="max-w-3xl mx-auto p-4 m-4 rounded-xl bg-red-900/30 text-red-200"><div className="font-bold mb-1">Runtime error</div><div className="text-sm whitespace-pre-wrap">{String(this.state.err)}</div></div>;} return this.props.children; }
    }

    const BRAND = { bg:"#0c0c0c", panel:"#151515", accent:"#d11111", text:"#f5f5f5", subtext:"#c7c7c7", cloth:"#03C04A" };
    const TABLE_PRESETS = {
      "7' (bar)": { W: 39, L: 78 },
      "8' (standard)": { W: 44, L: 88 },
      "8' (pro)": { W: 46, L: 92 },
      "9' (tournament)": { W: 50, L: 100 },
    };
    const presetKeys = Object.keys(TABLE_PRESETS);
    const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
    const INCH_TO_M = 0.0254;
    const BALL_D = 2.25, BALL_R = BALL_D/2;

    function firstCushionDistance({ x0, y0, dx, dy, W, L }) {
      const candidates = [];
      if (dy > 0) candidates.push((L - y0) / dy);
      if (dx < 0) candidates.push((0 - x0) / dx);
      if (dx > 0) candidates.push((W - x0) / dx);
      const t = Math.min(...candidates.filter(t=>t>0));
      return isFinite(t) ? t : null;
    }
    function buildRackPositions(variant, W, L) {
      const rackY = (3*L)/4; const cx = W/2; const rows = [];
      if (variant === '8') { const counts = [1,2,3,4,5];
        for (let r=0; r<counts.length; r++) { const n = counts[r]; const y = rackY + r*BALL_D; const rowWidth = (n-1)*BALL_D;
          for (let i=0; i<n; i++) rows.push({ x: cx - rowWidth/2 + i*BALL_D, y, row:r, idx:i, n }); }
      } else { const counts = [1,2,3,2,1];
        for (let r=0; r<counts.length; r++) { const n = counts[r]; const y = rackY + r*BALL_D; const rowWidth = (n-1)*BALL_D;
          for (let i=0; i<n; i++) rows.push({ x: cx - rowWidth/2 + i*BALL_D, y, row:r, idx:i, n }); }
      }
      return rows;
    }

    const LS_KEY = "promethean-breakspeed-v0.2.1";
    function loadState() { try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; } }
    function saveState(state) { try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {} }

    function computeStats(entries) {
      if (!entries || !entries.length) return null;
      const speeds = entries.map((e) => e.mph).filter((x) => Number.isFinite(x));
      if (!speeds.length) return null;
      const sum = speeds.reduce((a, b) => a + b, 0);
      return { avg: sum / speeds.length, high: Math.max(...speeds), low: Math.min(...speeds) };
    }

    function App() {
      const [tab, setTab] = useState('record');
      const [presetIndex, setPresetIndex] = useState(3);
      const presetKey = presetKeys[presetIndex] || "9' (tournament)";
      const dims = TABLE_PRESETS[presetKey];
      const W = dims.W, L = dims.L;
      const [phoneSide, setPhoneSide] = useState('right');
      const [variant, setVariant] = useState('9');
      const [snap, setSnap] = useState(true);
      const [cue, setCue] = useState({ x: 25, y: 20 });
      const [ghost, setGhost] = useState({ x: W/2, y: (3*L/4) - BALL_D });
      const [lastValidGhost, setLastValidGhost] = useState(null);
      const [unit, setUnit] = useState("mph");
      const [isRecording, setIsRecording] = useState(false);
      const [tTip, setTTip] = useState(null);
      const [tRack, setTRack] = useState(null);
      const [result, setResult] = useState(null);
      const [confirmOpen, setConfirmOpen] = useState(false);
      const [history, setHistory] = useState([]);
      const [accordionOpen, setAccordionOpen] = useState(false);
      const [initModal, setInitModal] = useState({ open:false, pending:null });
      const [tutorialOpen, setTutorialOpen] = useState(false);
      const [tutorialStep, setTutorialStep] = useState(1);
      const [tutorialDontShow, setTutorialDontShow] = useState(false);
      const [slotHelpOpen, setSlotHelpOpen] = useState(false);

      // Break slots (1–5)
      const [breakSlots, setBreakSlots] = useState([null,null,null,null,null]);
      const [slotModal, setSlotModal] = useState({ open:false, kind:null, index:null });

      useEffect(() => {
        const saved = loadState();
        if (saved) {
          setPresetIndex(saved.presetIndex ?? 3);
          setCue(saved.cue || { x: 25, y: 20 });
          setGhost(saved.ghost || { x: W/2, y: (3*L/4) - BALL_D });
          setUnit(saved.unit || "mph");
          setHistory(saved.history || []);
          setPhoneSide(saved.phoneSide || 'right');
          setTab(saved.tab || 'record');
          setVariant(saved.variant || '9');
          setSnap(saved.snap ?? true);
          setAccordionOpen(saved.accordionOpen ?? false);
          setTutorialOpen(saved.tutorialDone ? false : true);
          setBreakSlots(saved.breakSlots || [null,null,null,null,null]);
        } else {
          setTutorialOpen(true);
        }
      }, []);
      useEffect(() => {
        saveState({
          presetIndex, cue, ghost, unit, history, phoneSide, tab, variant, snap, accordionOpen, breakSlots,
          tutorialDone: !tutorialOpen || tutorialDontShow
        });
        localStorage.setItem("pg_initials", ""); // preserved key placeholder
      }, [presetIndex, cue, ghost, unit, history, phoneSide, tab, variant, snap, accordionOpen, tutorialOpen, tutorialDontShow, breakSlots]);

      useEffect(() => {
        setCue((p)=> ({ x: clamp(p.x, 0, W), y: clamp(p.y, 0, L/4) }));
        setGhost((g)=> ({ x: clamp(g.x, 0, W), y: clamp(g.y, BALL_R, L - BALL_R) }));
      }, [W, L]);

      const rackBalls = useMemo(() => buildRackPositions(variant, W, L), [variant, W, L]);

      function computeContactGhost(source, targetX, targetY) {
        const vx = targetX - source.x, vy = targetY - source.y;
        let len = Math.hypot(vx, vy);
        if (len < 1e-6) return null;
        const dx = vx / len, dy = vy / len;
        const R = 2*BALL_R;
        let bestT = Infinity, contactPoint = null;
        for (const b of rackBalls) {
          const mx = source.x - b.x, my = source.y - b.y;
          const dm = dx*mx + dy*my;
          const m2 = mx*mx + my*my;
          const C = m2 - R*R;
          const B = 2*dm;
          const disc = B*B - 4*C;
          if (disc < 0) continue;
          const sqrtDisc = Math.sqrt(disc);
          const t1 = (-B - sqrtDisc)/2;
          const t2 = (-B + sqrtDisc)/2;
          const t = t1 >= 0 ? t1 : (t2 >= 0 ? t2 : Infinity);
          if (t < bestT) { bestT = t; contactPoint = { x: source.x + dx*t, y: source.y + dy*t }; }
        }
        return contactPoint;
      }

      function cueToGhostDistanceIn(c=cue, g=ghost) {
        const dx = g.x - c.x, dy = g.y - c.y;
        const d = Math.hypot(dx, dy);
        if (dy <= 0 || d <= 0) return null;
        return d;
      }
      const legalHit = useMemo(() => {
        const d = cueToGhostDistanceIn();
        if (!d) return false;
        const dx = (ghost.x - cue.x)/d, dy = (ghost.y - cue.y)/d;
        const tCush = firstCushionDistance({ x0: cue.x, y0: cue.y, dx, dy, W, L });
        return !tCush || d <= tCush + 1e-6;
      }, [cue, ghost, W, L]);

      function distancesReadout(c=cue, g=ghost) {
        const dCG = cueToGhostDistanceIn(c, g);
        function f2(v){ return v===0 ? "0" : v.toFixed(2); }
        return { dCG: dCG ? f2(dCG) : "—" };
      }
      const readout = distancesReadout(cue, ghost);

      function formatSpeedMph(mps) { return (mps * 2.23693629).toFixed(2) + " mph"; }

      const timeoutRef = useRef(null);
      async function startCapture(onPeak){
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
        const source = audioCtx.createMediaStreamSource(stream);
        const hpf = audioCtx.createBiquadFilter(); hpf.type = "highpass"; hpf.frequency.value = 300;
        const lpf = audioCtx.createBiquadFilter(); lpf.type = "lowpass"; lpf.frequency.value = 6000;
        const analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
        source.connect(hpf); hpf.connect(lpf); lpf.connect(analyser);
        const buffer = new Float32Array(analyser.fftSize);
        let lastPeakTime = 0;
        let floor = 0.05; const UP = 0.02, DOWN = 0.005;
        const tick = () => {
          analyser.getFloatTimeDomainData(buffer);
          let max = 0; for (let i = 0; i < buffer.length; i++) max = Math.max(max, Math.abs(buffer[i]));
          floor = max > floor ? floor + UP * (max - floor) : floor - DOWN * (floor - max);
          floor = Math.max(0.02, Math.min(0.6, floor));
          const now = audioCtx.currentTime;
          const THRESH = Math.max(0.22, floor * 2.8);
          const REFRACT = 0.06;
          if (max > THRESH && now - lastPeakTime > REFRACT) { lastPeakTime = now; onPeak({ t: now, max }); }
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
        return { audioCtx, stream };
      }
      const mediaRef = useRef(null);
      const runningRef = useRef(false);

      const begin = async () => {
        const d = cueToGhostDistanceIn(cue,ghost);
        if (!d) { alert("Line would hit a cushion before the rack. Adjust cue/ghost."); return; }
        setResult(null); setTTip(null); setTRack(null);
        setIsRecording(true);
        try {
          runningRef.current = true;
          mediaRef.current = await startCapture((evt)=>{
            if (!tTip) { setTTip(evt.t); return; }
            const dt = evt.t - tTip;
            if (dt >= 0.01 && dt <= 0.25) { setTRack(evt.t); }
          });
          clearTimeout(timeoutRef.current);
          timeoutRef.current = setTimeout(() => {
            end();
            alert("No break detected in 30s. Tap Record to try again.");
          }, 30000);
        } catch (e) {
          console.error(e);
          setIsRecording(false);
          alert("Mic permission or init error. Please allow microphone access.");
        }
      };
      const end = () => {
        if (runningRef.current && mediaRef.current){
          mediaRef.current.stream.getTracks().forEach(t=>t.stop());
          mediaRef.current.audioCtx.close();
        }
        runningRef.current = false;
        mediaRef.current = null;
        setIsRecording(false);
        clearTimeout(timeoutRef.current);
      };

      useEffect(() => {
        if (tTip && tRack && isRecording) {
          const dIn = cueToGhostDistanceIn(cue, ghost) || 0;
          const dM = dIn * INCH_TO_M;
          const deltaT = Math.max(0.005, tRack - tTip);
          const mps = dM / deltaT;
          const mph = mps * 2.23693629;
          const res = { raw_mps:mps, mph:Number(mph.toFixed(2)), distanceIn:Number(dIn.toFixed(1)), deltaT:Number(deltaT.toFixed(4)), ts:Date.now(), cue, ghost, table:{ W, L }, variant };
          setHistory((h)=>[res, ...h].slice(0, 500));
          setResult(res);
          setIsRecording(false);
          end();
          setConfirmOpen(true);
        }
      }, [tTip, tRack, isRecording]);

      const svgRef = useRef(null);
      function snapCoord(v, max, divisions) {
        const step = max / divisions;
        const k = Math.round(v / step);
        const target = k * step;
        return Math.abs(v - target) <= 0.35 && snap ? target : v;
      }

      function GeometryDragViz({ sourceCue, setSourceCue, sourceGhost, setSourceGhost }) {
        const [dragCue, setDragCue] = useState(false);
        const [dragGhost, setDragGhost] = useState(false);
        const pad = 8;
        const containerW = Math.min(window.innerWidth - 16, 10000);
        const maxL = 680;
        const scale = Math.min(containerW / W, maxL / L);
        const sW = W * scale, sL = L * scale;
        const cx = sourceCue.x * scale + pad, cy = (sL - sourceCue.y * scale) + pad;
        const gx = sourceGhost.x * scale + pad, gy = (sL - sourceGhost.y * scale) + pad;

        const onDownGhost = (evt) => {
          evt.preventDefault();
          setDragGhost(true);
          const rect = svgRef.current.getBoundingClientRect();
          const move = (ev)=>{
            const p={x:ev.clientX - rect.left, y:ev.clientY - rect.top};
            let tx=(p.x - pad) / scale; let ty=(sL - (p.y - pad)) / scale;
            tx = clamp(snapCoord(tx, W, 8), 0, W); ty = clamp(snapCoord(ty, L, 8), BALL_R, L - BALL_R);
            const contact = computeContactGhost(sourceCue, tx, ty);
            if (contact) { setSourceGhost(contact); setLastValidGhost(contact); }
            else if (lastValidGhost) { setSourceGhost(lastValidGhost); }
          };
          const up = ()=>{ setDragGhost(false); window.removeEventListener('pointermove', move); };
          window.addEventListener('pointermove', move, { passive:true });
          window.addEventListener('pointerup', up, { once:true });
        };

        const onDownCue = (evt) => {
          evt.preventDefault();
          setDragCue(true);
          const rect = svgRef.current.getBoundingClientRect();
          const move=(ev)=>{
            const p={x:ev.clientX - rect.left, y:ev.clientY - rect.top};
            let ix=(p.x - pad) / scale; let iy=(sL - (p.y - pad)) / scale;
            ix = clamp(snapCoord(ix, W, 8), 0, W); iy = clamp(snapCoord(iy, L, 8), 0, L/4);
            setSourceCue({ x: ix, y: iy });
          };
          const up=()=>{ setDragCue(false); window.removeEventListener('pointermove', move); };
          window.addEventListener('pointermove', move, { passive:true });
          window.addEventListener('pointerup', up, { once:true });
        };

        function rackBallCircle(b, key) {
          const x = b.x * scale + pad, y = (sL - b.y * scale) + pad;
          return <circle key={key} cx={x} cy={y} r={BALL_R*scale} fill="#ffffff" stroke="#000000" strokeWidth="1.25" />;
        }

        return (
          <svg ref={svgRef} width={sW + pad*2} height={sL + pad*2} className="rounded-xl touch-pan-y table-svg w-full" style={{ touchAction:'none' }}>
            <rect x={pad} y={pad} width={sW} height={sL} fill={BRAND.cloth} stroke={legalHit ? BRAND.accent : "#cc8400"} strokeWidth="2" />
            {Array.from({ length: 7 }, (_, i) => ((i + 1) / 8) * sW + pad).map((x, i) => (<line key={"gx"+i} x1={x} x2={x} y1={pad} y2={pad + sL} stroke="#2a2a2a" strokeDasharray="4 6" />))}
            {Array.from({ length: 7 }, (_, i) => ((i + 1) / 8) * sL + pad).map((y, i) => (<line key={"gy"+i} x1={pad} x2={pad + sW} y1={y} y2={y} stroke="#2a2a2a" strokeDasharray="4 6" />))}

            {/* cue → ghost ray */}
            <line x1={cx} y1={cy} x2={gx} y2={gy} stroke="#1e1e1e" strokeWidth="2.5" />

            {/* rack balls */}
            {rackBalls.map((b, i) => rackBallCircle(b, i))}

            {/* dashed crosshairs while dragging */}
            {dragGhost && (<g>
              <line x1={pad} y1={gy} x2={pad + sW} y2={gy} stroke="#d11111" strokeWidth="1.5" strokeDasharray="5 5" />
              <line x1={gx} y1={pad} x2={gx} y2={pad + sL} stroke="#d11111" strokeWidth="1.5" strokeDasharray="5 5" />
            </g>)}
            {dragCue && (<g>
              <line x1={pad} y1={cy} x2={pad + sW} y2={cy} stroke="#ffffff" strokeWidth="1.5" strokeDasharray="5 5" />
              <line x1={cx} y1={pad} x2={cx} y2={pad + sL} stroke="#ffffff" strokeWidth="1.5" strokeDasharray="5 5" />
            </g>)}

            {/* ghost & cue */}
            <circle cx={gx} cy={gy} r={BALL_R*scale} fill="#d11111" stroke="#000000" strokeWidth="2"
              onPointerDown={onDownGhost} style={{ touchAction:'none', cursor:'grab' }} />
            <circle cx={cx} cy={cy} r={BALL_R*scale} fill="#ffffff" stroke="#000000" strokeWidth="1.75"
              onPointerDown={onDownCue} style={{ touchAction:'none', cursor:'grab' }} />
          </svg>
        );
      }

      function StatsPanel() {
        const s = useMemo(() => computeStats(history), [history]);
        const entries = [...history].reverse();
        const speedsMph = entries.map(e => e.mph);
        const yMax = 35;
        const w = 600, h = 220, pad = 34;
        const n = Math.max(1, entries.length);
        const xScale = (i) => pad + (i / Math.max(1, n - 1)) * (w - pad*2);
        const yScale = (v) => h - pad - (Math.min(v, yMax) / yMax) * (h - pad*2);
        const points = speedsMph.map((mph, i) => ({ x: xScale(i), y: yScale(mph) }));
        const path = points.length ? points.map((p, i) => (i===0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`)).join(" ") : "";

        return (
          <div className="flex flex-col gap-4">
            <div className="p-4 rounded-xl pg-panel">
              <h2 className="text-lg font-semibold mb-3">Stats</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div className="p-3 rounded bg-neutral-800">
                  <div className="text-xs text-gray-400">High</div>
                  <div className="text-xl font-bold">{s ? s.high.toFixed(2) : "—"} mph</div>
                </div>
                <div className="p-3 rounded bg-neutral-800">
                  <div className="text-xs text-gray-400">Average</div>
                  <div className="text-xl font-bold">{s ? s.avg.toFixed(2) : "—"} mph</div>
                </div>
                <div className="p-3 rounded bg-neutral-800">
                  <div className="text-xs text-gray-400">Low</div>
                  <div className="text-xl font-bold">{s ? s.low.toFixed(2) : "—"} mph</div>
                </div>
              </div>

              <div className="mt-3 rounded-lg overflow-hidden bg-neutral-900 p-2">
                <svg width={w} height={h}>
                  <line x1={pad} y1={h-pad} x2={w-pad/2} y2={h-pad} stroke="#666" strokeWidth="1.5" />
                  <line x1={pad} y1={pad/2} x2={pad} y2={h-pad} stroke="#666" strokeWidth="1.5" />
                  <text x={w - pad} y={h - pad + 18} fill="#888" fontSize="10" textAnchor="end">Break #</text>
                  <text x={pad - 10} y={pad/2 + 4} fill="#888" fontSize="10" textAnchor="end">{yMax.toFixed(0)} mph</text>
                  <text x={pad - 10} y={h - pad} fill="#888" fontSize="10" textAnchor="end">0</text>
                  {[1,2,3,4].map(i => {
                    const yy = yScale(i * (yMax/5));
                    return <line key={i} x1={pad} y1={yy} x2={w - pad/2} y2={yy} stroke="#222" strokeDasharray="4 5" />;
                  })}
                  {path && <path d={path} fill="none" stroke="#e74c3c" strokeWidth="2" />}
                  {points.map((p, i) => (
                    <g key={i}>
                      <circle cx={p.x} cy={p.y} r="3" fill="#e74c3c" />
                      <text x={p.x} y={p.y - 6} fill="#bbb" fontSize="9" textAnchor="middle">{(speedsMph[i]).toFixed(1)}</text>
                    </g>
                  ))}
                </svg>
              </div>
            </div>
          </div>
        );
      }

      function SettingsPanel() {
        return (
          <div className="p-4 rounded-xl pg-panel">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-semibold">Settings</h2>
              <button className="btn text-xs" onClick={()=>{ setTutorialStep(1); setTutorialOpen(true); }}>Open tutorial</button>
            </div>

            <div className="mb-6">
              <div className="text-sm text-gray-300 mb-2">Phone placement</div>
              <div className="flex gap-3 justify-between items-stretch flex-wrap">
                <div onClick={()=>setPhoneSide('left')}
                     className={"tile cursor-pointer flex-1 basis-[calc(50%-0.375rem)] min-w-[260px] " + (phoneSide==='left' ? "selected" : "")}>
                  <img src="https://prometheangamescom.wordpress.com/wp-content/uploads/2025/09/table-left.png"
                       className="w-full h-auto block" alt="Phone on left" />
                  <div className="px-3 py-2 text-center text-xs">Left side</div>
                </div>
                <div onClick={()=>setPhoneSide('right')}
                     className={"tile cursor-pointer flex-1 basis-[calc(50%-0.375rem)] min-w-[260px] " + (phoneSide==='right' ? "selected" : "")}>
                  <img src="https://prometheangamescom.wordpress.com/wp-content/uploads/2025/09/table-right.png"
                       className="w-full h-auto block" alt="Phone on right" />
                  <div className="px-3 py-2 text-center text-xs">Right side</div>
                </div>
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              <div className="space-y-4">
                <div className="text-sm text-gray-300">Table size</div>
                <div className="flex items-start gap-4">
                  <div className="vslider-wrap">
                    <input className="vslider" type="range" min="0" max={presetKeys.length-1} step="1" value={presetIndex}
                      onChange={(e)=>setPresetIndex(parseInt(e.target.value))} />
                  </div>
                  <div className="text-sm flex-1">
                    {presetKeys.map((k, idx)=> (
                      <div key={k} onClick={()=>setPresetIndex(idx)} className={"flex items-center justify-between gap-3 py-2 px-2 rounded cursor-pointer " + (idx===presetIndex ? "bg-[#1f1f1f] text-white" : "text-gray-400 hover:text-gray-200 hover:bg-[#1a1a1a]")}>
                        <div className="flex items-center gap-2">
                          <div className={"w-2 h-2 rounded-full " + (idx===presetIndex ? "bg-red-600" : "bg-gray-600")}></div>
                          <div>{k}</div>
                        </div>
                        <div className="text-xs text-gray-400">{TABLE_PRESETS[k].W}×{TABLE_PRESETS[k].L} in</div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className="space-y-6">
                <div className="flex items-center justify-between p-2 rounded bg-[#1a1a1a]">
                  <div className="text-sm">Enable snap-to-grid positioning</div>
                  <input type="checkbox" className="chk" checked={snap} onChange={(e)=>setSnap(e.target.checked)} />
                </div>

                <div className="flex items-center justify-between p-2 rounded bg-[#1a1a1a]">
                  <div className="text-sm">Format</div>
                  <div className="seg">
                    {["8","9"].map(v => (
                      <button key={v} className={variant===v ? "on" : ""} onClick={()=>setVariant(v)}>{v}-ball</button>
                    ))}
                  </div>
                </div>

                <div className="flex items-center justify-between p-2 rounded bg-[#1a1a1a]">
                  <div className="text-sm">Speed units</div>
                  <div className="seg">
                    {["mph","ft/s","m/s","kph"].map(u => (
                      <button key={u} className={unit===u ? "on" : ""} onClick={()=>setUnit(u)}>{u}</button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      function SlotHelpModal(){
        if (!slotHelpOpen) return null;
        return (
          <div className="modal" onClick={()=>setSlotHelpOpen(false)}>
            <div className="pg-panel rounded-xl p-4 modal-card" onClick={(e)=>e.stopPropagation()}>
              <div className="flex items-center justify-between">
                <div className="text-lg font-semibold">Break presets</div>
                <button className="btn text-xs" onClick={()=>setSlotHelpOpen(false)}>Close</button>
              </div>
              <div className="mt-3 text-sm text-gray-300 modal-body space-y-2">
                <div>Use the five slots below the table to quickly recall favorite break setups.</div>
                <ul className="list-disc pl-5">
                  <li><span className="font-semibold">Tap</span> a slot to <span className="font-semibold">load</span> it (you’ll get a confirmation).</li>
                  <li><span className="font-semibold">Long-press</span> a slot to <span className="font-semibold">save/overwrite</span> with the current table layout (confirmation shown).</li>
                  <li>Saved slots show a subtle highlight.</li>
                </ul>
                <div className="text-xs text-gray-400">Layout includes cue &amp; ghost positions, variant, table size, and snap setting.</div>
              </div>
            </div>
          </div>
        );
      }

      function useLongPressSlot({ onShort, onLong, ms=520 }){
        const timerRef = useRef(null);
        const start = (e) => { e.preventDefault(); clearTimeout(timerRef.current); timerRef.current = setTimeout(() => { onLong && onLong(e); }, ms); };
        const onPointerUp = (e) => { if (timerRef.current){ clearTimeout(timerRef.current); onShort && onShort(e); } };
        const clear = () => { clearTimeout(timerRef.current); };
        return { onTouchStart:start, onMouseDown:start, onTouchEnd:onPointerUp, onMouseUp:onPointerUp, onMouseLeave:clear };
      }

      function SlotModal(){
        if (!slotModal.open) return null;
        const idx = slotModal.index;
        const kind = slotModal.kind; // 'load' | 'save'
        const hasExisting = !!breakSlots[idx];
        const title = kind==='load' ? `Load Slot ${idx+1}?` : (hasExisting ? `Overwrite Slot ${idx+1}?` : `Save to Slot ${idx+1}?`);
        const desc = kind==='load'
          ? "This will replace your current table layout with the saved setup."
          : (hasExisting ? "This will replace the existing saved setup for this slot." : "This will save your current layout to this slot.");
        return (
          <div className="modal">
            <div className="pg-panel rounded-xl p-4 modal-card">
              <div className="text-lg font-semibold mb-1">{title}</div>
              <div className="text-sm text-gray-400 mb-2">{desc}</div>
              <div className="flex justify-end gap-2 mt-3">
                <button className="btn" onClick={()=>setSlotModal({open:false, kind:null, index:null})}>Cancel</button>
                <button className="btn" style={{background:'#2a2a2a'}} onClick={()=>{
                  if (kind==='load') {
                    const snapData = breakSlots[idx];
                    if (snapData){
                      setCue(snapData.cue); setGhost(snapData.ghost);
                      setVariant(snapData.variant); setPresetIndex(snapData.presetIndex);
                      setSnap(snapData.snap);
                    }
                  } else {
                    const payload = { cue, ghost, variant, presetIndex, snap, savedAt: Date.now() };
                    setBreakSlots(arr => { const next = [...arr]; next[idx] = payload; return next; });
                  }
                  setSlotModal({open:false, kind:null, index:null});
                }}>{kind==='load' ? "Load" : (hasExisting ? "Overwrite" : "Save")}</button>
              </div>
            </div>
          </div>
        );
      }

      function OnboardingModal() {
        if (!tutorialOpen) return null;
        const startRef = useRef(null);
        const onStart = (e) => { startRef.current = e.clientX || (e.touches && e.touches[0]?.clientX) || 0; };
        const onEnd = (e) => {
          const endX = e.clientX || (e.changedTouches && e.changedTouches[0]?.clientX) || 0;
          const dx = (endX - (startRef.current||0));
          const TH = 48;
          if (dx < -TH) next();
          if (dx > TH) prev();
        };
        const next = () => setTutorialStep(s => Math.min(3, s+1));
        const prev = () => setTutorialStep(s => Math.max(1, s-1));
        const dots = (<div className="flex items-center justify-center gap-1">{[1,2,3].map(i => <div key={i} className={"dot " + (i===tutorialStep ? "on" : "")}></div>)}</div>);
        return (
          <div className="modal">
            <div className="pg-panel rounded-xl p-4 modal-card" onTouchStart={onStart} onTouchEnd={onEnd} onPointerDown={onStart} onPointerUp={onEnd}>
              <div className="flex items-center justify-between mb-2">
                <div className="text-lg font-semibold">Welcome to Promethean Break Speed</div>
                <button className="text-gray-400 hover:text-gray-200" onClick={()=>{ setTutorialOpen(false); }}>Skip</button>
              </div>
              <div className="h-[1px] bg-neutral-800 mb-3"></div>

              <div className="modal-body space-y-4 touch-area">
                {tutorialStep===1 && (
                  <div className="space-y-3">
                    <div className="text-sm text-gray-300 font-semibold">1) Microphone access</div>
                    <p className="text-sm text-gray-400">
                      We detect two sharp sounds: <span className="font-semibold text-white">tip impact</span> and <span className="font-semibold text-white">cue-ball/rack</span> contact.
                      Time between them (Δt) plus the measured cue→rack distance yields your speed. Audio is processed locally; nothing leaves your device.
                    </p>
                    <div className="flex gap-3">
                      <button className="btn" onClick={async()=>{
                        try { await navigator.mediaDevices.getUserMedia({ audio:true }); alert("Microphone permission granted."); }
                        catch(e){ alert("Permission denied or unavailable. You can enable mic later in your browser settings."); }
                      }}>Allow microphone</button>
                    </div>
                  </div>
                )}

                {tutorialStep===2 && (
                  <div className="space-y-3">
                    <div className="text-sm text-gray-300 font-semibold">2) Aim setup — cue &amp; ghost</div>
                    <p className="text-sm text-gray-400">
                      Drag the <span className="font-semibold text-white">white</span> cue ball and <span className="font-semibold text-white">red</span> ghost ball on the table to match your intended first contact.
                      Enable <span className="font-semibold">snap-to-grid</span> in Settings for quick alignment.
                    </p>
                  </div>
                )}

                {tutorialStep===3 && (
                  <div className="space-y-3">
                    <div className="text-sm text-gray-300 font-semibold">3) Record &amp; confirm</div>
                    <p className="text-sm text-gray-400">
                      Tap <span className="font-semibold text-white">Record</span>, break, then confirm the first contact if needed. Results save to <span className="font-semibold">Stats</span>.
                    </p>
                    <div className="text-xs text-gray-500">Auto-timeout after 30s if no break is detected.</div>
                    <label className="flex items-center gap-2 mt-2">
                      <input type="checkbox" className="chk" checked={tutorialDontShow} onChange={(e)=>setTutorialDontShow(e.target.checked)} />
                      <span className="text-sm text-gray-300">Don’t show on startup</span>
                    </label>
                  </div>
                )}
              </div>

              <div className="h-[1px] bg-neutral-800 my-3"></div>
              <div className="flex items-center justify-between gap-3 flex-wrap">
                <div className="flex items-center gap-2">
                  <button className="btn text-xs" onClick={prev} disabled={tutorialStep===1} style={{opacity: tutorialStep===1?0.5:1}}>‹ Back</button>
                  <button className="btn text-xs" onClick={next} disabled={tutorialStep===3} style={{opacity: tutorialStep===3?0.5:1}}>Next ›</button>
                </div>
                {dots}
                <div className="flex items-center gap-2">
                  <button className="btn text-xs" onClick={()=>{ setTutorialOpen(false); }}>Close</button>
                  {tutorialStep===3 && (
                    <button className="btn text-xs" style={{background:'#2a2a2a'}} onClick={()=>{ setTutorialOpen(false); setTutorialDontShow(true); }}>Finish</button>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function ConfirmModal() {
        if (!confirmOpen || !result) return null;
        return (
          <div className="modal">
            <div className="pg-panel rounded-xl p-4 modal-card">
              <div className="text-lg font-semibold mb-2">Confirm first contact</div>
              <div className="text-xs text-gray-400 mb-2">If the real first contact differed, drag to match what actually happened, then confirm.</div>
              <div className="modal-body">
                <GeometryDragViz sourceCue={cue} setSourceCue={setCue} sourceGhost={ghost} setSourceGhost={setGhost} />
              </div>
              <div className="flex justify-end gap-2 mt-3">
                <button className="btn" onClick={()=>{ setConfirmOpen(false); }}>Looks right</button>
                <button className="btn" onClick={()=>{ setConfirmOpen(false); }}>Confirm</button>
              </div>
            </div>
          </div>
        );
      }

      function SharkPanel() {
        return (
          <div className="flex flex-col gap-4">
            <div className="p-4 rounded-xl pg-panel">
              <div className="flex items-center justify-between flex-wrap gap-2">
                <div className="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight">Shark Mode</div>
              </div>

              <details className="mt-3" open={accordionOpen} onToggle={(e)=>setAccordionOpen(e.target.open)}>
                <summary className="list-none cursor-pointer px-3 py-2 rounded bg-[#1b1b1b] hover:bg-[#232323]">Table setup (toggle)</summary>
                <div className="mt-3">
                  <GeometryDragViz sourceCue={cue} setSourceCue={setCue} sourceGhost={ghost} setSourceGhost={setGhost} />
                </div>
              </details>

              <div className="mt-4 flex items-center justify-center">
                {!isRecording ? (
                  <button className="round-record" onClick={begin}>REC</button>
                ) : (
                  <button className="round-record" style={{background:'#6b6b6b'}} onClick={end}>STOP</button>
                )}
              </div>
            </div>
          </div>
        );
      }

      function RecordPanel() {
        function onSlotPress(i){ setSlotModal({ open:true, kind:'load', index:i }); }
        function onSlotLong(i){ setSlotModal({ open:true, kind:'save', index:i }); }
        function SlotButton({ i }){
          const saved = !!breakSlots[i];
          const bind = useLongPressSlot({ onShort: ()=>onSlotPress(i), onLong: ()=>onSlotLong(i), ms:520 });
          return <button className={"preset-btn w-full text-center " + (saved ? "saved" : "")} {...bind}>Slot {i+1}</button>;
        }

        return (
          <div className="grid md:grid-cols-2 gap-4">
            <div className="p-4 rounded-xl pg-panel">
              <div className="flex items-center justify-between flex-wrap gap-2">
                <div className="text-sm text-gray-200">Distance: {readout.dCG}"</div>
              </div>

              <details className="mt-3" open={accordionOpen} onToggle={(e)=>setAccordionOpen(e.target.open)}>
                <summary className="list-none cursor-pointer px-3 py-2 rounded bg-[#1b1b1b] hover:bg-[#232323]">
                  Interactive table (toggle)
                </summary>
                <div className="mt-3">
                  <GeometryDragViz sourceCue={cue} setSourceCue={setCue} sourceGhost={ghost} setSourceGhost={setGhost} />
                </div>
              </details>

              <div className="mt-3 flex items-center justify-between">
                <div className="text-xs text-gray-300 flex items-center gap-2">
                  <span className="font-semibold">Break presets</span>
                  <div className="help-icon" title="How presets work" onClick={()=>setSlotHelpOpen(true)}>?</div>
                </div>
              </div>
              <div className="mt-2 grid grid-cols-5 gap-2">
                {[0,1,2,3,4].map(i => <SlotButton key={i} i={i} />)}
              </div>

              {!legalHit && <div className="mt-3 text-xs text-amber-300">Warning: current ray hits a cushion before rack.</div>}
            </div>

            <div className="p-4 rounded-xl pg-panel flex flex-col gap-4">
              <div className="flex flex-col gap-3">
                <div>
                  <div className="text-sm text-gray-400">Cue → Rack</div>
                  <div className="text-5xl font-bold tracking-tight">
                    {result ? formatSpeedMph(result.raw_mps) : "--.-- mph"}
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <span className="text-xs text-gray-400">Units</span>
                  <div className="seg">
                    {["mph","ft/s","m/s","kph"].map(u => (
                      <button key={u} className={unit===u ? "on" : ""} onClick={()=>setUnit(u)}>{u}</button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="flex flex-wrap items-center gap-3 justify-between">
                {!isRecording ? (
                  <button onClick={begin} className="tap-big font-semibold" style={{ background: BRAND.accent }}>
                    Tap to Record — Break
                  </button>
                ) : (
                  <button onClick={end} className="tap-big font-semibold bg-neutral-700">Stop</button>
                )}
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen" style={{ background: BRAND.bg, color: BRAND.text }}>
          <header className="sticky top-0 z-10 border-b border-neutral-800" style={{ background: BRAND.bg, paddingTop:'var(--safe-top)' }}>
            <div className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-3 h-6" style={{ background: BRAND.accent }}></div>
                <h1 className="text-lg font-semibold">Promethean Break Speed <span className="text-xs text-gray-500">v0.2.1</span></h1>
              </div>
              <div className="text-[11px] text-gray-400">Phone: face up just beyond the {phoneSide} headstring diamond</div>
            </div>
          </header>

          <main className="max-w-5xl mx-auto px-2 sm:px-4 py-4 pb-28">
            {tab === 'record' && <RecordPanel />}
            {tab === 'settings' && <SettingsPanel />}
            {tab === 'stats' && <StatsPanel />}
            {tab === 'shark' && <SharkPanel />}
          </main>

          <OnboardingModal />
          <ConfirmModal />
          <SlotHelpModal />
          <SlotModal />

          <nav className="nav-fixed">
            <div className="max-w-5xl mx-auto px-2 sm:px-4 py-2 flex items-center justify-between gap-2">
              <button className={"btn flex-1 icon-btn " + (tab==='settings' ? "ring-2 ring-red-600" : "")} onClick={()=>setTab('settings')} title="Settings">⚙️</button>
              <button className={"btn flex-1 " + (tab==='record' ? "ring-2 ring-red-600" : "")} onClick={()=>setTab('record')}>Record</button>
              <button className={"btn flex-1 " + (tab==='stats' ? "ring-2 ring-red-600" : "")} onClick={()=>setTab('stats')}>Stats</button>
              <button className={"btn flex-1 " + (tab==='shark' ? "ring-2 ring-red-600" : "")} onClick={()=>setTab('shark')}>Shark Mode</button>
            </div>
          </nav>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<ErrorBoundary><App /></ErrorBoundary>);
  </script>
</body>
</html>
